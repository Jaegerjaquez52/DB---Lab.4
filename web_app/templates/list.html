{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ title }}</h1>
    
    {# --- –ü–û–®–£–ö --- #}
    {% if title == 'üçΩÔ∏è –ú–µ–Ω—é' %}
        <form method="GET" class="form-inline" style="margin-left: auto; margin-right: 10px;">
            <input type="text" name="search" placeholder="–ü–æ—à—É–∫ —Å—Ç—Ä–∞–≤–∏..." 
                   value="{{ search_query if search_query else '' }}" 
                   style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <button type="submit" class="btn btn-secondary btn-small">üîç</button>
            {% if search_query %}
                <a href="{{ request.path }}" class="btn btn-danger btn-small" title="–°–∫–∏–Ω—É—Ç–∏ –ø–æ—à—É–∫">‚úï</a>
            {% endif %}
        </form>
    {% endif %}

    {# --- –õ–û–ì–Ü–ö–ê –ö–ù–û–ü–ö–ò "–î–û–î–ê–¢–ò" --- #}
    {% if add_url %}
        {# –î–ª—è –ú–µ–Ω—é —Ç–∞ –ü–µ—Ä—Å–æ–Ω–∞–ª—É: –î–æ–¥–∞–≤–∞—Ç–∏ –º–æ–∂–µ —Ç—ñ–ª—å–∫–∏ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä #}
        {% if title == 'üçΩÔ∏è –ú–µ–Ω—é' or title == 'üßë‚Äçüíº –ü–µ—Ä—Å–æ–Ω–∞–ª' %}
            {% if session.role == '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' %}
                <a href="{{ url_for(add_url) }}" class="btn btn-primary">‚ûï –î–æ–¥–∞—Ç–∏</a>
            {% endif %}
        
        {# –î–ª—è –ó–∞–º–æ–≤–ª–µ–Ω—å —Ç–∞ –ö–ª—ñ—î–Ω—Ç—ñ–≤: –î–æ–¥–∞–≤–∞—Ç–∏ –º–æ–∂—É—Ç—å —É—Å—ñ (–æ—Ñ—ñ—Ü—ñ–∞–Ω—Ç–∏ —Ç–µ–∂) #}
        {% else %}
            <a href="{{ url_for(add_url) }}" class="btn btn-primary">‚ûï –î–æ–¥–∞—Ç–∏</a>
        {% endif %}
    {% endif %}
</div>

{% if items %}
<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                {# –í–∏–≤—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –∫–æ–ª–æ–Ω–æ–∫ #}
                {% for col in columns %}
                <th>{{ col }}</th>
                {% endfor %}
                
                {#! --- –ó–ê–ì–û–õ–û–í–ö–ò –°–ü–ï–¶–Ü–ê–õ–¨–ù–ò–• –ö–û–õ–û–ù–û–ö --- #}
                
                {# 1. –ó–ê–ú–û–í–õ–ï–ù–ù–Ø: –ó–∞–≤–∂–¥–∏ –ø–æ–∫–∞–∑—É—î–º–æ –°—Ç–∞—Ç—É—Å —ñ –î—ñ—ó #}
                {% if title == 'üìù –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è' %}
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î—ñ—ó</th>
                {% else %}
                    {% if session.role == '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' %}
                        <th>–î—ñ—ó</th>
                    {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                {# –í–∏–≤—ñ–¥ –æ—Å–Ω–æ–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö #}
                {% for field in fields %}
                <td>
                    {% if field == 'price' or field == 'total_amount' or field == 'total_revenue' %}
                        {{ "%.2f"|format(item[field]) }} –≥—Ä–Ω
                    {% elif field == 'order_status' %}
                        <span class="badge badge-{{ item[field]|lower }}">{{ item[field] }}</span>
                    {% elif field == 'order_time' or field == 'created_at' or field == 'hire_date' %}
                        {{ item[field].strftime('%d.%m.%Y %H:%M') if item[field] else '-' }}
                    {% else %}
                        {{ item[field] }}
                    {% endif %}
                </td>
                {% endfor %}
                
                {# --- –í–ú–Ü–°–¢ –°–ü–ï–¶–Ü–ê–õ–¨–ù–ò–• –ö–û–õ–û–ù–û–ö --- #}
                
                {# 1. –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #}
                {% if title == 'üìù –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è' %}
                    <td>
                        {# –ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å—ñ–º #}
                        <form method="POST" action="{{ url_for('update_order_status', order_id=item.order_id) }}" class="form-inline">
                            <select name="new_status" onchange="this.form.submit()" class="status-select status-select-{{ item.order_status|lower }}">
                                {% set all_statuses = ['NEW', 'PREPARING', 'READY', 'PAID', 'CANCELLED'] %}
                                {% for status in all_statuses %}
                                    <option value="{{ status }}" {% if item.order_status == status %}selected{% endif %}>{{ status }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td class="actions">
                        {# –î–µ—Ç–∞–ª—ñ –±–∞—á–∞—Ç—å —É—Å—ñ #}
                        <a href="{{ url_for('orders_details', order_id=item.order_id) }}" class="btn btn-small btn-info">üëÅÔ∏è</a>
                        
                        {# –í–∏–¥–∞–ª—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–æ–∂–µ –¢–Ü–õ–¨–ö–ò –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä #}
                        {% if session.role == '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' %}
                            <a href="{{ url_for('orders_delete', order_id=item.order_id) }}" 
                               class="btn btn-small btn-delete"
                               onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')">üóëÔ∏è</a>
                        {% endif %}
                    </td>

                {# 2. –Ü–ù–®–Ü –°–ü–ò–°–ö–ò (–ú–µ–Ω—é, –ü–µ—Ä—Å–æ–Ω–∞–ª, –ö–ª—ñ—î–Ω—Ç–∏) #}
                {% else %}
                    {# –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è –±–∞—á–∏—Ç—å –¢–Ü–õ–¨–ö–ò –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä #}
                    {% if session.role == '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' %}
                        <td class="actions">
                            {% if edit_url %}
                                <a href="{{ url_for(edit_url, **{id_param: item[id_field]}) }}" class="btn btn-small btn-edit">‚úèÔ∏è</a>
                            {% endif %}
                            
                            {% if delete_url %}
                                <a href="{{ url_for(delete_url, **{id_param: item[id_field]}) }}" 
                                   class="btn btn-small btn-delete"
                                   onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞ –¥—ñ—è.')">üóëÔ∏è</a>
                            {% endif %}
                        </td>
                    {% endif %}
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="table-info">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤: {{ items|length }}</p>

{% else %}
<div class="empty-state">
    <p>–î–∞–Ω–∏—Ö –ø–æ–∫–∏ –Ω–µ–º–∞—î</p>
    {# –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–∏—Å—É –∑–∞ —Ç—ñ—î—é –∂ –ª–æ–≥—ñ–∫–æ—é #}
    {% if add_url %}
        {% if title == 'üçΩÔ∏è –ú–µ–Ω—é' or title == 'üßë‚Äçüíº –ü–µ—Ä—Å–æ–Ω–∞–ª' %}
            {% if session.role == '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' %}
                <a href="{{ url_for(add_url) }}" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å</a>
            {% endif %}
        {% else %}
            <a href="{{ url_for(add_url) }}" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å</a>
        {% endif %}
    {% endif %}
</div>
{% endif %}
{% endblock %}